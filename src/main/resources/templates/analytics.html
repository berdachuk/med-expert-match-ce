<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head}">
    <title>MedExpertMatch - Network Analytics</title>
</head>
<body>
<header th:replace="~{fragments/header :: header}"></header>
<main class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h1 class="h3 mb-4">Network Analytics</h1>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Generate Network Analytics</h5>
                </div>
                <div class="card-body long-running-block">
                    <div class="long-running-actions" id="generate-area">
                        <button class="btn btn-primary" id="generate-btn" type="button">Generate Analytics</button>
                    </div>
                    <p class="long-running-msg" id="long-running-msg">Long-running job. Generating network
                        analytics may take one to several minutes while the system queries the expertise graph and runs
                        analytics. You can cancel the request at any time.</p>
                    <div class="long-running-progress align-items-center gap-3" id="progress-area"
                         style="display: none;">
                        <div aria-label="Loading" class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading</span>
                        </div>
                        <span class="long-running-progress-text" id="progress-text">Generating analytics...</span>
                        <button class="btn btn-outline-secondary btn-sm long-running-cancel" id="cancel-btn"
                                type="button">Cancel
                        </button>
                    </div>
                </div>
            </div>

            <div class="alert alert-danger d-none" id="error-alert" role="alert"></div>
            <div class="alert alert-secondary d-none long-running-cancelled" id="cancelled-alert" role="alert">Request
                cancelled.
            </div>

            <div class="card" id="result-card" th:classappend="${analyticsResult == null} ? 'd-none' : ''">
                <div class="card-header">
                    <h5 class="mb-0">Analytics Results</h5>
                </div>
                <div class="card-body">
                    <div class="markdown-body mb-0" id="result-body"
                         th:attr="data-raw=${analyticsResult != null ? analyticsResult.response : null}"></div>
                </div>
            </div>

            <div class="card d-none mb-4" id="log-panel" th:if="${isAdmin}">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Execution logs</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary" id="log-clear-btn" type="button">Clear</button>
                        <button class="btn btn-sm btn-outline-secondary" id="log-toggle-btn" type="button">
                            <i class="bi bi-chevron-down" id="log-toggle-icon"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body" id="log-panel-body">
                    <div id="log-container"
                         style="height: 280px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace; font-size: 12px; padding: 10px; border-radius: 4px;">
                        <div id="log-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<footer th:replace="~{fragments/footer :: footer}"></footer>

<style>
    .markdown-body {
        font-size: 0.9375rem;
        line-height: 1.6;
    }

    .markdown-body h1, .markdown-body h2, .markdown-body h3 {
        margin-top: 1em;
        margin-bottom: 0.5em;
        font-weight: 600;
    }

    .markdown-body h1 {
        font-size: 1.5em;
    }

    .markdown-body h2 {
        font-size: 1.25em;
    }

    .markdown-body h3 {
        font-size: 1.1em;
    }

    .markdown-body pre, .markdown-body code {
        background: var(--bs-secondary-bg, #f8f9fa);
        border-radius: 0.25rem;
    }

    .markdown-body pre {
        padding: 0.75rem 1rem;
        overflow-x: auto;
    }

    .markdown-body code {
        padding: 0.2em 0.4em;
        font-size: 0.9em;
    }

    .markdown-body pre code {
        padding: 0;
    }

    .markdown-body ul, .markdown-body ol {
        margin-bottom: 0.5em;
        padding-left: 1.5em;
    }

    .markdown-body p {
        margin-bottom: 0.5em;
    }

    .markdown-body p:last-child {
        margin-bottom: 0;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script th:inline="javascript">
    (function () {
        var generateBtn = document.getElementById('generate-btn');
        var progressArea = document.getElementById('progress-area');
        var generateArea = document.getElementById('generate-area');
        var cancelBtn = document.getElementById('cancel-btn');
        var errorAlert = document.getElementById('error-alert');
        var cancelledAlert = document.getElementById('cancelled-alert');
        var resultCard = document.getElementById('result-card');
        var resultBody = document.getElementById('result-body');
        var longRunningMsg = document.getElementById('long-running-msg');
        var logPanel = document.getElementById('log-panel');
        var logPanelBody = document.getElementById('log-panel-body');
        var logContainer = document.getElementById('log-container');
        var logContent = document.getElementById('log-content');
        var logClearBtn = document.getElementById('log-clear-btn');
        var logToggleBtn = document.getElementById('log-toggle-btn');
        var logToggleIcon = document.getElementById('log-toggle-icon');
        var abortController = null;
        var eventSource = null;
        var logPanelCollapsed = false;
        var maxLogEntries = 500;

        function addLogEntry(message, level) {
            if (!logContent) return;
            var entry = document.createElement('div');
            entry.style.marginBottom = '2px';
            entry.style.wordWrap = 'break-word';
            if (level === 'error' || (message && message.indexOf('[ERROR]') !== -1)) {
                entry.style.color = '#f48771';
            } else if (message && message.indexOf('[WARN]') !== -1) {
                entry.style.color = '#dcdcaa';
            } else if (message && message.indexOf('[INFO]') !== -1) {
                entry.style.color = '#4ec9b0';
            } else {
                entry.style.color = '#d4d4d4';
            }
            entry.textContent = message || '';
            logContent.appendChild(entry);
            if (logContainer) logContainer.scrollTop = logContainer.scrollHeight;
            while (logContent.children.length > maxLogEntries) {
                logContent.removeChild(logContent.firstChild);
            }
        }

        function initLogStream(sessionId) {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            var url = '/api/v1/logs/stream?sessionId=' + encodeURIComponent(sessionId);
            eventSource = new EventSource(url);
            eventSource.addEventListener('log', function (event) {
                addLogEntry(event.data);
            });
            eventSource.onerror = function () {
                if (eventSource && eventSource.readyState === EventSource.CLOSED) {
                    addLogEntry('[ERROR] Log connection closed.', 'error');
                }
            };
        }

        function closeLogStream() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
        }

        function setLoading(loading) {
            generateArea.classList.toggle('d-none', loading);
            progressArea.style.display = loading ? 'flex' : 'none';
            if (longRunningMsg) longRunningMsg.classList.toggle('d-none', loading);
            errorAlert.classList.add('d-none');
            cancelledAlert.classList.add('d-none');
            if (loading && logPanel) {
                logPanel.classList.remove('d-none');
                if (logPanelBody) logPanelBody.style.display = 'block';
            }
        }

        function renderMarkdown(text) {
            if (typeof marked !== 'undefined' && text && text.trim()) {
                try {
                    return marked.parse(text.trim());
                } catch (e) {
                    return escapeHtml(text);
                }
            }
            return text ? escapeHtml(text) : '';
        }

        function escapeHtml(s) {
            var div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function showResult(text) {
            resultBody.innerHTML = renderMarkdown(text || '');
            resultCard.classList.remove('d-none');
        }

        function showError(message) {
            errorAlert.textContent = message || 'Request failed.';
            errorAlert.classList.remove('d-none');
        }

        function showCancelled() {
            cancelledAlert.classList.remove('d-none');
        }

        if (logClearBtn && logContent) {
            logClearBtn.addEventListener('click', function () {
                logContent.innerHTML = '';
                addLogEntry('[Logs cleared]', 'info');
            });
        }
        if (logToggleBtn && logPanelBody) {
            logToggleBtn.addEventListener('click', function () {
                logPanelCollapsed = !logPanelCollapsed;
                logPanelBody.style.display = logPanelCollapsed ? 'none' : 'block';
                if (logToggleIcon) {
                    logToggleIcon.className = logPanelCollapsed ? 'bi bi-chevron-right' : 'bi bi-chevron-down';
                }
            });
        }

        generateBtn.addEventListener('click', function () {
            setLoading(true);
            abortController = new AbortController();
            var sessionId = 'network-' + Date.now();
            if (logContent) logContent.innerHTML = '';
            initLogStream(sessionId);
            fetch([[@{/api/v1/agent/network-analytics}]],
            {
                method: 'POST',
                    headers
            :
                {
                    'Content-Type'
                :
                    'application/json'
                }
            ,
                body: JSON.stringify({sessionId: sessionId}),
                    signal
            :
                abortController.signal
            }
        )
        .
            then(function (res) {
                if (!res.ok) throw new Error(res.statusText || 'Request failed');
                return res.json();
            })
                .then(function (data) {
                    closeLogStream();
                    setLoading(false);
                    abortController = null;
                    showResult(data.response != null ? data.response : JSON.stringify(data));
                    addLogEntry('[INFO] Network analytics completed.', 'info');
                })
                .catch(function (err) {
                    closeLogStream();
                    setLoading(false);
                    abortController = null;
                    if (err.name === 'AbortError') {
                        showCancelled();
                        addLogEntry('[WARN] Request cancelled.', 'warn');
                    } else {
                        showError(err.message || 'Failed to load network analytics.');
                        addLogEntry('[ERROR] Request failed: ' + (err.message || 'Unknown error'), 'error');
                    }
                });
        });

        cancelBtn.addEventListener('click', function () {
            if (abortController) {
                abortController.abort();
            }
        });

        var raw = resultBody.getAttribute('data-raw');
        if (raw) {
            resultBody.innerHTML = renderMarkdown(raw);
            resultBody.removeAttribute('data-raw');
        }
    })();
</script>
</body>
</html>
